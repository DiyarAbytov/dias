# Спецификация API для ОТК (контроль качества)

Фронт ожидает следующий контракт. После **выпуска** в Производстве партия должна попадать в ОТК.

---

## 1. Проблема сейчас

- Запросы **GET** к `http://127.0.0.1:8000/api/batches/` возвращают **404 Not Found**.
- Фронт вызывает этот endpoint с параметрами `page_size=50` (Производство) и `page_size=100` (ОТК).
- **Нужно:** реализовать или подключить endpoint **GET /api/batches/** и при выпуске создавать партию.

---

## 2. Связка «Производство → ОТК»

1. Пользователь на странице **Производство** нажимает «Выпустить», выбирает заказ и количество.
2. Фронт отправляет **POST /api/orders/{order_id}/release/** с телом: `{ "quantity": number }`.
3. **Бэкенд должен:** при успешном выпуске создавать запись **партии (batch)** и возвращать её (или обновлённый заказ). Партия — это одна «выпущенная» порция, которая потом идёт в ОТК.
4. Список партий фронт запрашивает через **GET /api/batches/**.

---

## 3. Endpoint: список партий

**GET /api/batches/**

**Параметры (query):**

| Параметр   | Тип   | Описание        |
|-----------|--------|-----------------|
| page      | number | Номер страницы  |
| page_size | number | Размер страницы (50, 100) |

**Ответ 200:**

```json
{
  "items": [
    {
      "id": 1,
      "order_id": 10,
      "order_name": "Печенье Классическое",
      "product_name": "Печенье Классическое",
      "quantity": 50,
      "released": 50,
      "operator_name": "admin",
      "operator": "admin",
      "date": "2026-02-11T18:02:17Z",
      "created_at": "2026-02-11T18:02:17Z",
      "otk_status": null,
      "otk_accepted": null,
      "otk_defect": null,
      "otk_defect_reason": null,
      "otk_comment": null,
      "otk_inspector": null,
      "otk_checked_at": null
    }
  ],
  "meta": {
    "total": 1,
    "page": 1,
    "page_size": 100
  }
}
```

**Поля партии (batch) для фронта:**

- **id** — id партии.
- **order_id** — id заказа (опционально).
- **order_name** или **product_name** — название заказа/продукта для отображения.
- **quantity** / **released** — количество выпущенной продукции (шт).
- **operator_name** / **operator** — ФИО или логин оператора.
- **date** / **created_at** — дата/время производства.
- **otk_status** — статус ОТК: `null` или пусто = ожидает проверки; после сохранения результата: `"accepted"` или `"defect"`.
- **otk_accepted** — принято шт (после проверки).
- **otk_defect** — брак шт.
- **otk_defect_reason** — причина брака (текст).
- **otk_comment** — комментарий инспектора.
- **otk_inspector** — ФИО или логин инспектора ОТК.
- **otk_checked_at** — дата/время проверки (ISO 8601).

Фронт сам делит партии на «ожидают проверки» (нет итога ОТК) и «история» (есть otk_status = accepted/defect или заполнены otk_checked_at / otk_accepted).

---

## 4. Endpoint: сохранить результат проверки ОТК

Фронт отправляет результат по нажатию «Сохранить результат» в модалке «Контроль качества».

**Вариант A: PATCH /api/batches/{batch_id}/**

**Тело запроса:**

```json
{
  "otk_accepted": 50,
  "otk_defect": 0,
  "otk_defect_reason": null,
  "otk_comment": "Партия принята",
  "otk_status": "accepted",
  "otk_inspector": "Abytov",
  "otk_checked_at": "2026-02-12T00:09:39Z"
}
```

**Правила:**

- **otk_accepted** — число, принято шт.
- **otk_defect** — число, брак шт.
- **otk_defect_reason** — строка или null; при браке > 0 фронт может требовать заполнение.
- **otk_comment** — строка или null.
- **otk_status** — `"accepted"` (если брак = 0) или `"defect"` (если брак > 0).
- **otk_inspector** — имя инспектора (фронт подставляет текущего пользователя).
- **otk_checked_at** — ISO 8601, время проверки (фронт может передавать своё).

**Вариант B (альтернатива): POST /api/batches/{batch_id}/otk_accept/**

Тело то же самое. Бэкенд обновляет партию и при необходимости связанный заказ/производство.

**Ответ:** 200 OK и объект партии (как в списке) с обновлёнными полями ОТК.

---

## 5. Обновление статусов в Заказах и Производстве

После сохранения результата ОТК бэкенд должен при необходимости:

- обновить статус заказа (например, на «выполнен» или «принято»), если по логике это нужно;
- обновить отображаемые данные в разделах «Заказы» и «Производство» (достаточно, чтобы при следующем GET заказов/партий приходили уже обновлённые статусы).

Фронт не вызывает отдельные endpoint’ы для заказов после ОТК — достаточно, чтобы при следующих запросах **GET /api/orders/** и **GET /api/batches/** данные были актуальными.

---

## 6. Кратко: что передать бэкенду

1. **Реализовать GET /api/batches/** с пагинацией (`page`, `page_size`). В ответе — массив партий с полями выше (в т.ч. все `otk_*`).
2. **При POST /api/orders/{id}/release/** — создавать партию (batch) и возвращать успех. Партия без заполненных `otk_*` будет показываться во вкладке «Ожидают проверки» в ОТК.
3. **Реализовать приём результата ОТК:** либо **PATCH /api/batches/{id}/** с полями `otk_accepted`, `otk_defect`, `otk_defect_reason`, `otk_comment`, `otk_status`, `otk_inspector`, `otk_checked_at`, либо **POST /api/batches/{id}/otk_accept/** с тем же телом.
4. После сохранения результата ОТК обновлять статусы заказа/производства по своей бизнес-логике, чтобы в «Заказы» и «Производство» отображались актуальные данные.

Если имена полей на бэкенде другие — можно описать маппинг (например, `qc_accepted` → фронт отдаёт как `otk_accepted`), тогда фронт можно будет подстроить.
