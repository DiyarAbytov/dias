# Спецификация API для ОТК (контроль качества)

Фронт ожидает следующий контракт. После **выпуска** в Производстве партия должна попадать в ОТК.

---

## 1. Связка «Производство → ОТК»

1. Пользователь на странице **Производство** нажимает «Выпустить», выбирает заказ и количество.
2. Фронт отправляет **POST /api/orders/{order_id}/release/** с телом: `{ "quantity": number }`.
3. **Бэкенд должен:** при успешном выпуске создавать запись **партии (batch)** и возвращать её (или обновлённый заказ). Партия — это одна «выпущенная» порция, которая потом идёт в ОТК.
4. Список партий фронт запрашивает через **GET /api/batches/**.

---

## 2. Endpoint: список партий

**GET /api/batches/**

**Параметры (query):**

| Параметр   | Тип   | Описание        |
|-----------|--------|-----------------|
| page      | number | Номер страницы  |
| page_size | number | Размер страницы (50, 100) |

**Ответ 200:**

```json
{
  "items": [
    {
      "id": 1,
      "order_id": 10,
      "order_name": "Печенье Классическое",
      "product_name": "Печенье Классическое",
      "quantity": 50,
      "released": 50,
      "operator_name": "admin",
      "operator": "admin",
      "date": "2026-02-11T18:02:17Z",
      "created_at": "2026-02-11T18:02:17Z",
      "otk_status": null,
      "otk_accepted": null,
      "otk_defect": null,
      "otk_defect_reason": null,
      "otk_comment": null,
      "otk_inspector": null,
      "otk_checked_at": null
    }
  ],
  "meta": {
    "total": 1,
    "page": 1,
    "page_size": 100
  }
}
```

**Поля партии (batch) для фронта:**

- **id** — id партии.
- **order_id** — id заказа (опционально).
- **order_name** или **product_name** — название заказа/продукта для отображения.
- **quantity** / **released** — количество выпущенной продукции (шт).
- **operator_name** / **operator** — ФИО или логин оператора.
- **date** / **created_at** — дата/время производства.
- **otk_status** — статус ОТК: `null` или пусто = ожидает проверки; после сохранения: `"accepted"` или `"rejected"` (брак).
- **otk_accepted** — принято шт (после проверки).
- **otk_defect** — брак шт.
- **otk_defect_reason** — причина брака (текст).
- **otk_comment** — комментарий инспектора.
- **otk_inspector** — ФИО или логин инспектора ОТК.
- **otk_checked_at** — дата/время проверки (ISO 8601).

Фронт делит партии на «ожидают проверки» (нет итога ОТК) и «история» (otk_status = accepted/rejected или заполнены otk_checked_at / otk_accepted). Поддерживаются фильтры по `otk_status` и `order`.

---

## 3. Endpoint: сохранить результат проверки ОТК (реализовано)

**POST /api/batches/{batch_id}/otk_accept/**

Фронт отправляет результат по нажатию «Сохранить результат» в модалке «Контроль качества».

**Тело запроса:**

```json
{
  "otk_accepted": 50,
  "otk_defect": 0,
  "otk_defect_reason": null,
  "otk_comment": "Партия принята",
  "otk_status": "accepted",
  "otk_inspector": "Abytov",
  "otk_checked_at": "2026-02-12T00:09:39Z"
}
```

**Правила (бэкенд):**

- Партия в статусе pending; сумма otk_accepted + otk_defect = выпущенное количество; при otk_defect > 0 обязательна otk_defect_reason.
- Создаётся OtkCheck (в т.ч. comment), обновляется batch.otk_status (`accepted` / `rejected`); при принятом количестве > 0 — запись на склад ГП.

**Ответ:** 200 OK, объект партии в формате GET /api/batches/.

---

## 4. Обновление статусов в Заказах и Производстве

После сохранения результата ОТК бэкенд должен при необходимости:

- обновить статус заказа (например, на «выполнен» или «принято»), если по логике это нужно;
- обновить отображаемые данные в разделах «Заказы» и «Производство» (достаточно, чтобы при следующем GET заказов/партий приходили уже обновлённые статусы).

Фронт не вызывает отдельные endpoint’ы для заказов после ОТК — достаточно, чтобы при следующих запросах **GET /api/orders/** и **GET /api/batches/** данные были актуальными.

---

## 5. Реализованный контракт (сводка)

| Элемент | Реализация |
|--------|------------|
| **GET /api/batches/** | BatchViewSet, BatchListSerializer, пагинация (page, page_size), фильтры otk_status, order. Партии создаются при release в ProductionReleaseView. |
| **POST /api/batches/{id}/otk_accept/** | Action otk_accept: валидация (pending, сумма принято+брак = выпуск, при браке > 0 — причина). OtkCheck, batch.otk_status (accepted/rejected), при принятом > 0 — склад ГП. Ответ — объект партии. |
| **otk_status** | Бэкенд: `accepted` \| `rejected`. Фронт шлёт `rejected`, когда брак > 0 и принято = 0. |

Документ можно передать бэкендеру как описание контракта ОТК.
